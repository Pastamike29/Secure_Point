import React, { useState } from 'react';
import {
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Box,
  Dialog,
  DialogActions,
  DialogContent,
  DialogContentText,
  DialogTitle,
  IconButton,
} from '@mui/material';
import { UploadFile, Close } from '@mui/icons-material';
import AdminDashboardLayout from '../Component/AdminDashboardLayout';
import Papa from 'papaparse';
import { toast, ToastContainer } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
import { SelectChangeEvent } from '@mui/material';


interface AddVulnerabilityProps {
  onUpload: (categories: { owasp: string; issueName: string }[]) => void;
}

export default function AddVulnerability() {
  const [file, setFile] = useState<File | null>(null);
  const [vulName, setVulName] = useState('');
  const [vulType, setVulType] = useState('');
  const [issueName, setIssuename] = useState('');
  const [sourceCodeJavascript, setSourceCodeJavascript] = useState('');
  const [solvedCodeJavascript, setSolvedCodeJavascript] = useState('');
  const [sourceCodeJava, setSourceCodeJava] = useState('');
  const [solvedCodeJava, setSolvedCodeJava] = useState('');
  const [sourceCodeDotnet, setSourceCodeDotnet] = useState('');
  const [solvedCodeDotnet, setSolvedCodeDotnet] = useState('');
  const [sourceCodePomXML, setSourceCodePomXML] = useState('');
  const [sourceCodeXML, setSourceCodeXML] = useState('');
  const [sourceCodeDockerfile, setSourceCodeDockerfile] = useState('');
  const [solvedCodePomXML, setSolvedCodePomXML] = useState('');
  const [solvedCodeXML, setSolvedCodeXML] = useState('');
  const [solvedCodeDockerfile, setSolvedCodeDockerfile] = useState('');
  const [recommendation, setRecommendation] = useState('');
  const [description, setDescription] = useState('');
  const [openDialog, setOpenDialog] = useState(false);
  const [selectedLanguage, setSelectedLanguage] = useState('javascript'); // Initial language set to JavaScript
  const [sourceCodeRows, setSourceCodeRows] = useState(7); // Initial rows for Source Code
  const [solvedCodeRows, setSolvedCodeRows] = useState(5); // Initial rows for Solution


  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const selectedFile = e.target.files[0];
      setFile(selectedFile);

      // Parse the CSV file
      Papa.parse(selectedFile, {
        header: true,
        complete: (results) => {
          // Filter out empty or invalid rows
          const vulnerabilities = results.data
            .filter((row: any) => {
              // Check for required fields and trim any whitespace
              return (
                row.owasp?.trim() &&
                row.issueName?.trim() &&
                row.sub_issueName?.trim() &&
                row.description?.trim() &&
                row.recommendation?.trim()
              );
            })
            .map((row: any) => ({
              owasp: row.owasp.trim(),
              issueName: row.issueName.trim(),
              sub_issueName: row.sub_issueName?.trim() || '',
              description: row.description?.trim() || '',
              recommendation: row.recommendation?.trim() || '',
              issueCode_Javascript: row.issueCode_Javascript?.trim() || '',
              solveCode_Javascript: row.solveCode_Javascript?.trim() || '',
              issueCode_Java: row.issueCode_Java?.trim() || '',
              solveCode_Java: row.solveCode_Java?.trim() || '',
              issueCode_Dotnet: row.issueCode_Dotnet?.trim() || '',
              solveCode_Dotnet: row.solveCode_Dotnet?.trim() || '',
              issue_Pom_xml: row.issue_Pom_xml?.trim() || '',
              solve_Pom_xml: row.solve_Pom_xml?.trim() || '',
              issue_xml: row.issue_xml?.trim() || '',
              solve_xml: row.solve_xml?.trim() || '',
              issue_Dockerfile: row.issue_Dockerfile?.trim() || '',
              solve_Dockerfile: row.solve_Dockerfile?.trim() || '',
            }));

          if (vulnerabilities.length === 0) {
            toast.error('The CSV file is empty or contains invalid rows.');
            console.log('Parsed Data:', results.data); // Log raw data for debugging
            return;
          }


          toast.success('Upload successful! Please submit the form.');

          // Send data to backend
          sendDataToBackend(vulnerabilities);
        },
        error: () => {
          toast.error('Failed to parse the file. Please upload the file again.');
        },
      });
    }
  };


  const sendDataToBackend = async (vulnerabilities: {
    owasp: string;
    issueName: string;
    sub_issueName: string;
    description: string;
    recommendation: string;
    issueCode_Javascript: string;
    solveCode_Javascript: string;
    issueCode_Java: string;
    solveCode_Java: string;
    issueCode_Dotnet: string;
    issue_Pom_xml: string;
    solve_Pom_xml: string;
    issue_xml: string;
    solve_xml: string;
    issue_Dockerfile: string;
    solve_Dockerfile: string;
  }[]) => {
    try {
      const response = await fetch('http://localhost:5000/api/vulnerabilities', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(vulnerabilities),
      });

      if (!response.ok) {
        throw new Error('Failed to upload vulnerabilities');
      }

      const data = await response.json();
      console.log('Uploaded successfully:', data);
    } catch (error) {
      console.error('Error uploading vulnerabilities:', error);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (file) {
      // Clear all fields and reset after successful submission
      toast.success('Submit success!');
      resetForm();
    } else {
      // Handle form data submission when no file is uploaded
      const formData = {
        vulName,
        vulType,
        issueName,
        recommendation,
        description,
      };

      console.log(formData);
      toast.success('Submit success!');
      resetForm();
    }
  };

  const resetForm = () => {
    setFile(null);
    setVulName('');
    setVulType('');
    setIssuename('');
    setRecommendation('');
    setDescription('');
    setSourceCodeJavascript('');
    setSolvedCodeJavascript('');
    setSourceCodeJava('');
    setSolvedCodeJava('');
    setSourceCodeDotnet('');
    setSourceCodePomXML('');
    setSourceCodeXML('');
    setSourceCodeDockerfile('');
    setSolvedCodePomXML('');
    setSolvedCodeXML('');
    setSolvedCodeDockerfile('');
    setSolvedCodeDotnet('');

    // Reset the file input
    const fileInput = document.getElementById('upload-file') as HTMLInputElement;
    if (fileInput) {
      fileInput.value = ''; // Clear file input field
    }
  };
  const handleCancelClick = () => {
    setOpenDialog(true);
  };

  const handleDialogClose = (confirm: boolean) => {
    setOpenDialog(false);
    if (confirm) {
      resetForm();
    }
  };

  const handleFileRemove = () => {
    resetForm();
  };

  const handleIssueCodeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    switch (selectedLanguage) {
      case 'javascript':
        setSourceCodeJavascript(value);
        break;
      case 'java':
        setSourceCodeJava(value);
        break;
      case 'dotnet':
        setSourceCodeDotnet(value);
        break;
      case 'PomXML':
        setSourceCodePomXML(value);
        break;
      case 'XML':
        setSourceCodeXML(value);
        break;
      case 'Docker':
        setSourceCodeDockerfile(value);
        break;
    }

    const lines = value.split('\n').length;
    setSourceCodeRows(lines > 5 ? Math.min(lines, 20) : 7); // Adjust source code input size
  };

  const handleSolvedCodeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    switch (selectedLanguage) {
      case 'javascript':
        setSolvedCodeJavascript(value);
        break;
      case 'java':
        setSolvedCodeJava(value);
        break;
      case 'dotnet':
        setSolvedCodeDotnet(value);
        break;
      case 'PomXML':
        setSolvedCodePomXML(value);
        break;
      case 'XML':
        setSolvedCodeXML(value);
        break;
      case 'Docker':
        setSolvedCodeDockerfile(value);
        break;
    }

    const lines = value.split('\n').length;
    setSolvedCodeRows(lines > 5 ? Math.min(lines, 20) : 5); // Adjust solution input size
  };

  const handleLanguageChange = (event: SelectChangeEvent<string>) => {
    setSelectedLanguage(event.target.value);
  };

  return (
    <AdminDashboardLayout title="Vulnerability Management">
      <ToastContainer />
      <Grid container spacing={3}>
        <Grid item xs={12}>
          <Card sx={{ width: '90%' }}>
            <CardContent>
              <Box display="flex" justifyContent="space-between" alignItems="center">
                <Typography variant="h6" gutterBottom>
                  Add Vulnerability
                </Typography>
                <label htmlFor="upload-file">
                  <input
                    accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    style={{ display: 'none' }}
                    id="upload-file"
                    type="file"
                    onChange={handleFileChange}
                  />
                  <Button
                    variant="contained"
                    component="span"
                    startIcon={<UploadFile />}
                    size="small"
                  >
                    Upload .CSV file
                  </Button>
                </label>
              </Box>

              <form onSubmit={handleSubmit}>
                <TextField
                  fullWidth
                  label="Vulnerability Name"
                  value={vulName}
                  onChange={(e) => setVulName(e.target.value)}
                  margin="normal"
                  required={!file}
                />

                <FormControl fullWidth margin="normal">
                  <InputLabel id="vul-type-label">Vulnerability type (OWASP)</InputLabel>
                  <Select
                    labelId="vul-type-label"
                    value={vulType}
                    onChange={(e) => setVulType(e.target.value)}
                    label="Vulnerability Type"
                    required={!file}
                  >
                    <MenuItem value="A01">A01: Broken Access Control</MenuItem>
                    <MenuItem value="A02">A02: Cryptographic Failures</MenuItem>
                    <MenuItem value="A03">A03: Injection</MenuItem>
                    <MenuItem value="A04">A04: Insecure Design</MenuItem>
                    <MenuItem value="A05">A05: Security Misconfiguration</MenuItem>
                    <MenuItem value="A06">A06: Vulnerable and Outdated Components</MenuItem>
                    <MenuItem value="A07">A07: Identification and Authentication Failures</MenuItem>
                    <MenuItem value="A08">A08: Software and Data Integrity Failures</MenuItem>
                    <MenuItem value="A09">A09: Security Logging and Monitoring Failures</MenuItem>
                    <MenuItem value="A10">A10: Server-Side Request Forgery (SSRF)</MenuItem>
                  </Select>
                </FormControl>


                <TextField
                  fullWidth
                  label="IssueName"
                  value={issueName}
                  onChange={(e) => setIssuename(e.target.value)}
                  margin="normal"
                  multiline
                  rows={1}
                  required={!file}
                />


                <FormControl fullWidth margin="normal">
                  <InputLabel id="language-select-label">Select Language</InputLabel>
                  <Select
                    labelId="language-select-label"
                    value={selectedLanguage}
                    onChange={handleLanguageChange}
                    label="Select Language"
                  >
                    <MenuItem value="javascript">JavaScript</MenuItem>
                    <MenuItem value="java">Java</MenuItem>
                    <MenuItem value="dotnet">.NET</MenuItem>
                    <MenuItem value="PomXML">Pom XML</MenuItem>
                    <MenuItem value="XML">XML</MenuItem>
                    <MenuItem value="Docker File">Docker File</MenuItem>
                  </Select>
                </FormControl>

            
                <TextField
                  fullWidth
                  label={`Source Code (Issue) - ${selectedLanguage}`}
                  value={
                    selectedLanguage === 'javascript'
                      ? sourceCodeJavascript
                      : selectedLanguage === 'java'
                        ? sourceCodeJava
                        : selectedLanguage === 'dotnet'
                          ? sourceCodeDotnet
                          : selectedLanguage === 'PomXML'
                            ? sourceCodePomXML
                            : selectedLanguage === 'XML'
                              ? sourceCodeXML
                              : sourceCodeDockerfile
                  }
                  onChange={handleIssueCodeChange}
                  margin="normal"
                  multiline
                  rows={sourceCodeRows}
                />

                <TextField
                  fullWidth
                  label={`Source Code (Solve method) - ${selectedLanguage}`}
                  value={
                    selectedLanguage === 'javascript'
                      ? solvedCodeJavascript
                      : selectedLanguage === 'java'
                        ? solvedCodeJava
                        : selectedLanguage === 'dotnet'
                          ? solvedCodeDotnet
                          : selectedLanguage === 'PomXML'
                            ? solvedCodePomXML
                            : selectedLanguage === 'XML'
                              ? solvedCodeXML
                              : solvedCodeDockerfile
                  }
                  onChange={handleSolvedCodeChange}
                  margin="normal"
                  multiline
                  rows={solvedCodeRows}
                  required={!file}
                />
                
                <TextField
                  fullWidth
                  label="Description"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  margin="normal"
                  multiline
                  rows={3}
                  required={!file}
                />

                <TextField
                  fullWidth
                  label="Recommendation"
                  value={recommendation}
                  onChange={(e) => setRecommendation(e.target.value)}
                  margin="normal"
                  multiline
                  rows={2}
                  required={!file}
                />


                <Box display="flex" justifyContent="space-between" mt={2}>
                  <Button variant="contained" color="primary" type="submit">
                    Submit
                  </Button>
                  <Button variant="outlined" color="secondary" onClick={handleCancelClick}>
                    Cancel
                  </Button>
                </Box>
              </form>

              {file && (
                <Box display="flex" alignItems="center" mt={2}>
                  <Typography>Selected File: {file.name}</Typography>
                  <IconButton onClick={handleFileRemove} color="error" aria-label="remove file">
                    <Close />
                  </IconButton>
                </Box>
              )}
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      <Dialog open={openDialog} onClose={() => handleDialogClose(false)}>
        <DialogTitle>Reset Form</DialogTitle>
        <DialogContent>
          <DialogContentText>Do you want to reset all fields and the uploaded file?</DialogContentText>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => handleDialogClose(false)} color="primary">
            No
          </Button>
          <Button onClick={() => handleDialogClose(true)} color="secondary" autoFocus>
            Yes
          </Button>
        </DialogActions>
      </Dialog>
    </AdminDashboardLayout>
  );
}
